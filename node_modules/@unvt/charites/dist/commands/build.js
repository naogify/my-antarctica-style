"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.build = void 0;
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const yaml_parser_1 = require("../lib/yaml-parser");
const validate_style_1 = require("../lib/validate-style");
const defaultValues_1 = require("../lib/defaultValues");
const jsonminify_1 = __importDefault(require("jsonminify"));
function build(source, destination, options) {
    let sourcePath = path_1.default.resolve(process.cwd(), source);
    // The `source` is absolute path.
    if (source.match(/^\//)) {
        sourcePath = source;
    }
    if (!fs_1.default.existsSync(sourcePath)) {
        throw `${sourcePath}: No such file or directory`;
    }
    let destinationPath = "";
    if (destination) {
        if (destination.match(/^\//)) {
            destinationPath = destination;
        }
        else {
            destinationPath = path_1.default.resolve(process.cwd(), destination);
        }
    }
    else {
        destinationPath = path_1.default.join(path_1.default.dirname(sourcePath), `${path_1.default.basename(source, '.yml')}.json`);
    }
    let provider = defaultValues_1.defaultValues.provider;
    if (options.provider) {
        provider = options.provider;
    }
    let style = '';
    try {
        const _style = yaml_parser_1.parser(sourcePath);
        validate_style_1.validateStyle(_style, provider);
        style = JSON.stringify(_style, null, '  ');
        if (options.compactOutput) {
            style = jsonminify_1.default(style);
        }
    }
    catch (err) {
        if (err) {
            throw err;
        }
        else {
            throw `${sourcePath}: Invalid YAML syntax`;
        }
    }
    try {
        fs_1.default.writeFileSync(destinationPath, style);
    }
    catch (err) {
        throw `${destinationPath}: Permission denied`;
    }
}
exports.build = build;
